# Radaroid Project Rules

> Configuration for Cursor AI ‚Äî Based on Architecture V3.5 (Production-Ready)

## Architecture

- **Framework:** Next.js 14+ App Router (NO Pages Router)
- **Database:** Supabase (Postgres) ‚Äî NO Prisma, use @supabase/supabase-js
- **Styling:** TailwindCSS + Shadcn/UI only
- **Validation:** Zod for runtime validation
- **Deploy:** Vercel
- **Images:** plaiceholder for blur generation

## Project Structure

```
app/                    # Next.js App Router pages
‚îú‚îÄ‚îÄ robots/            # Robot catalog
‚îú‚îÄ‚îÄ jobs/              # Job-based rankings (SEO landing)
‚îú‚îÄ‚îÄ glossary/          # Technical wiki
‚îú‚îÄ‚îÄ tracker/           # Deployment tracker
‚îú‚îÄ‚îÄ compare/           # Robot comparator
‚îî‚îÄ‚îÄ embed/             # Embeddable badges

components/
‚îú‚îÄ‚îÄ ui/                # Shadcn components
‚îú‚îÄ‚îÄ scores/            # CapabilitiesChart, MaturityBadge
‚îú‚îÄ‚îÄ modals/            # Lead gen modals
‚îî‚îÄ‚îÄ layout/            # Header, Footer

lib/
‚îú‚îÄ‚îÄ supabase/          # Supabase clients
‚îú‚îÄ‚îÄ scoring/           # Score calculation engine
‚îú‚îÄ‚îÄ seo/               # JSON-LD helpers
‚îú‚îÄ‚îÄ validators/        # Zod schemas (robot-specs, scoring-criteria, email)
‚îú‚îÄ‚îÄ rate-limit.ts      # In-memory rate limiter + honeypot
‚îî‚îÄ‚îÄ hooks/             # React hooks

types/
‚îú‚îÄ‚îÄ database.ts        # Supabase generated types
‚îî‚îÄ‚îÄ scoring.ts         # Scoring interfaces
```

## Scoring Engine (CRITICAL)

- Always use `calculateScore()` from `lib/scoring/engine.ts`
- Never hardcode scoring rules ‚Äî read from `jobs.scoring_criteria` JSON
- Support 3 types: `numeric`, `boolean`, `enum_score`
- Score range: 0-100

‚ö†Ô∏è **Score Calculation Formula:**
```typescript
// CORRECT: Divide by totalWeight (sum of evaluated criteria weights)
const finalScore = Math.round(totalWeightedScore / totalWeight)

// WRONG: Never divide by hardcoded 100!
// const finalScore = totalScore / 100  ‚ùå BUG!
```

```typescript
// Example usage
const result = calculateScore(robot.specs, job.scoring_criteria.criteria)
// result.score = 85
// result.breakdown = { payload: 100, stability: 70 }
// result.missing = ['terrain_handling']  // specs not provided
```

## Score Dual (CRITICAL)

‚ö†Ô∏è **NEVER merge technical score and maturity score**

1. **Technical Score (Potentiel Technique):** 0-100
   - Algorithm-based on specs vs job criteria
   - Source: `robot_job_scores.score_tech`

2. **Maturity Index (Indice de Maturit√©):** Status badge
   - Based on verified deployments
   - Values: `prototype` | `pilot` | `production`
   - Source: `deployments` table count + `robots.status`

**Display them SEPARATELY ‚Äî Never combine into single score**

## Data Validation (V3.5)

Always validate with Zod BEFORE database operations:

```typescript
import { validateRobotSpecs } from '@/lib/validators/robot-specs'
import { validateScoringCriteria } from '@/lib/validators/scoring-criteria'
import { validateEmail } from '@/lib/validators/email'

// Validate robot specs
const validation = validateRobotSpecs(specs)
if (!validation.success) {
  throw new Error(validation.error)
}

// Validate scoring criteria
const criteriaValidation = validateScoringCriteria(job.scoring_criteria)
if (!criteriaValidation.success) {
  throw new Error(criteriaValidation.error)
}

// Validate email (blocks disposable domains)
const emailValidation = validateEmail(userEmail)
if (!emailValidation.valid) {
  return { error: emailValidation.error }
}
```

## Soft Delete (V3.5)

‚ö†Ô∏è **NEVER use SQL DELETE on main tables**

```typescript
// WRONG ‚ùå
await supabase.from('robots').delete().eq('id', robotId)

// CORRECT ‚úì
await supabase.from('robots').update({ deleted_at: new Date().toISOString() }).eq('id', robotId)
```

Use `active_*` views for queries:
```typescript
// Queries should use the views that filter deleted items
const { data } = await supabase.from('active_robots').select('*')
```

## Rate Limiting & Anti-Spam (V3.5)

All public forms MUST implement:

```typescript
import { rateLimit, isHoneypotFilled, getClientIP } from '@/lib/rate-limit'
import { validateEmail } from '@/lib/validators/email'

export async function submitForm(formData: FormData, headers: Headers) {
  // 1. Check honeypot (invisible field)
  if (isHoneypotFilled(formData)) {
    return { error: 'Invalid submission' }  // Silent fail for bots
  }

  // 2. Check rate limit (5 req/min/IP)
  const ip = getClientIP(headers)
  const rateLimitResult = rateLimit(ip, 5, 60000)
  if (!rateLimitResult.success) {
    return { error: 'Too many requests. Please wait.' }
  }

  // 3. Validate email (no disposable domains)
  const email = formData.get('email') as string
  const emailValidation = validateEmail(email)
  if (!emailValidation.valid) {
    return { error: emailValidation.error }
  }

  // 4. Proceed with form submission...
}
```

Honeypot field in forms:
```tsx
{/* Hidden honeypot field - bots will fill this */}
<input
  type="text"
  name="website"
  className="absolute -left-[9999px]"
  tabIndex={-1}
  autoComplete="off"
/>
```

## UX Cold Start

When a robot has no verified deployments:

```typescript
if (deploymentsCount === 0) {
  // Show "üß™ LAB RATED ONLY" badge
  // Gray out maturity section
  // Show call-to-action: "Vous l'avez d√©ploy√© ? T√©moignez ‚Üí"
}
```

## i18n Pattern

All DB queries MUST JOIN on `_i18n` tables:

```typescript
const { data } = await supabase
  .from('active_robots')  // Use active_* views
  .select(`
    *,
    i18n:robots_i18n!inner(*)
  `)
  .eq('i18n.locale', locale)
```

**Tables with i18n:**
- `robots` ‚Üí `robots_i18n`
- `jobs` ‚Üí `jobs_i18n`
- `glossary_terms` ‚Üí `glossary_terms_i18n`

## Images

- Use `blur_data_url` from `robot_media` for Layout Shift prevention
- Generate blur with plaiceholder library

```typescript
import { getPlaiceholder } from 'plaiceholder'

const { base64 } = await getPlaiceholder(imageUrl)
// Store base64 in robot_media.blur_data_url
```

## Lead Generation

- "Interested" button ‚Üí Simple email modal ‚Üí `intent_leads` table
- Job Alert form ‚Üí `job_alerts` table
- NO Stripe checkout
- NO complex auth
- Site is read-only for public

```typescript
// Server Action pattern with validation
async function submitInterest(formData: FormData) {
  'use server'

  const email = formData.get('email') as string

  // Validate email
  const emailValidation = validateEmail(email)
  if (!emailValidation.valid) {
    return { error: emailValidation.error }
  }

  const supabase = await createClient()
  await supabase.from('intent_leads').insert({
    robot_id: formData.get('robot_id'),
    user_email: emailValidation.normalized,
    user_industry: formData.get('industry'),
    fleet_size_interest: formData.get('fleet_size')
  })
}
```

## Mobile First

- Use `CapabilitiesChart` fallback (horizontal bars) on screens < 768px
- Never render Radar Chart on mobile

```typescript
const isMobile = useMediaQuery('(max-width: 768px)')

if (isMobile) {
  return <HorizontalBars scores={scores} />
}
return <RadarChart scores={scores} />
```

## LLM SEO

Every page MUST have JSON-LD Schema.org markup:

| Page Type | Schema |
|-----------|--------|
| Robot | Product + Review + Organization |
| Job | ItemList + HowTo |
| Glossary | DefinedTerm |
| Compare | ItemList |

Include "citable sentences" in page introductions:
```
"L'Optimus Gen 2 de Tesla obtient un score de 85/100 pour le m√©tier de manutentionnaire."
```

Maintain `/public/llms.txt` for AI crawler context.

## Unit Conversion

- ALWAYS store in Metric (SI) in database: `kg`, `cm`, `km/h`
- Use `useUnitConversion` hook for display
- Auto-convert to Imperial (`lbs`, `ft`, `mph`) if `locale === 'en-US'`

```typescript
const { convert, unit } = useUnitConversion()
// convert(25, 'kg') ‚Üí { value: 55.12, unit: 'lbs' } (if en-US)
// convert(25, 'kg') ‚Üí { value: 25, unit: 'kg' } (if fr)
```

## Component Patterns

### Server Components (default)
- Pages (`page.tsx`)
- Layouts (`layout.tsx`)
- Data fetching components

### Client Components ('use client')
- Interactive UI (modals, forms)
- Charts (Recharts)
- Hooks consumers (useMediaQuery)

## Data Fetching

- Use Server Components for initial data
- Use ISR with `revalidate` for semi-static pages
- No client-side fetching for critical content

```typescript
// app/robots/[slug]/page.tsx
export const revalidate = 86400 // 24 hours

export default async function RobotPage({ params }) {
  const supabase = await createClient()
  const { data } = await supabase.from('active_robots')...
}
```

## Anti-Patterns (DO NOT)

‚ùå NO public authentication (site is read-only)
‚ùå NO forum/comments (use `error_reports` instead)
‚ùå NO Stripe payments
‚ùå NO single merged score
‚ùå NO Pages Router (`pages/` directory)
‚ùå NO Prisma ORM
‚ùå NO inline styles (use Tailwind)
‚ùå NO Radar Chart on mobile
‚ùå NO hardcoded scoring rules
‚ùå NO SQL DELETE (use soft delete with `deleted_at`)
‚ùå NO score calculation with `/100` (use `/totalWeight`)
‚ùå NO form submission without rate limiting
‚ùå NO email acceptance without validation

## File Naming

- Components: `PascalCase.tsx`
- Utilities: `kebab-case.ts`
- Hooks: `use-kebab-case.ts`
- Types: `kebab-case.ts`
- Validators: `kebab-case.ts`

## Commit Messages

Follow conventional commits:
- `feat:` new feature
- `fix:` bug fix
- `refactor:` code change without feature/fix
- `docs:` documentation
- `style:` formatting
- `test:` tests

## Testing

- Unit tests: Jest + Testing Library
- E2E tests: Playwright (optional)
- Test scoring engine thoroughly (especially totalWeight calculation)
- Test responsive breakpoints
- Test rate limiting behavior
- Test email validation (disposable domains blocked)

---

*Radaroid Cursor Rules v2.0 ‚Äî Based on Architecture V3.5 Production-Ready*
